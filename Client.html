<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gioco Territoriale Semplice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #1a202c; color: white; font-family: 'Inter', sans-serif; }
        canvas { border: 1px solid #4A5568; background-color: #2D3748; cursor: pointer; border-radius: 0.5rem; }
        .controls { margin-top: 20px; padding: 10px; background-color: #2D3748; border-radius: 0.5rem; }
        .player-info { margin-bottom:10px; font-size: 0.9rem; }
        .color-picker-container { display: flex; align-items: center; gap: 10px; }
        .color-picker-container label { margin-bottom: 0; }
        #messageBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #48BB78;
            color: white;
            padding: 10px 20px;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none; /* Nascosto di default */
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="bg-gray-800 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="messageBox">Messaggio!</div>

    <h1 class="text-3xl font-bold mb-6">Gioco Territoriale</h1>

    <div class="player-info" id="playerInfoContainer">
        <p>Il tuo ID: <span id="playerIdDisplay" class="font-semibold">In attesa...</span></p>
        <p>Il tuo colore: <span id="playerColorDisplay" class="font-semibold w-4 h-4 inline-block rounded border border-gray-400" style="background-color: transparent;"></span></p>
    </div>
    
    <canvas id="gameCanvas"></canvas>

    <div class="controls">
        <div class="color-picker-container">
            <label for="playerColorPicker" class="text-sm">Scegli il tuo colore:</label>
            <input type="color" id="playerColorPicker" value="#FF0000" class="h-8 w-14 rounded border border-gray-500">
            <button id="changeColorButton" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-sm">Cambia Colore</button>
        </div>
    </div>

    <script>
        // Configurazione Iniziale
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const TILE_SIZE = 20; // Dimensione di una cella in pixel
        const GRID_WIDTH = 30; // Numero di celle in larghezza
        const GRID_HEIGHT = 20; // Numero di celle in altezza

        canvas.width = TILE_SIZE * GRID_WIDTH;
        canvas.height = TILE_SIZE * GRID_HEIGHT;

        let gameGrid = []; // Array 2D per memorizzare lo stato della griglia [y][x]
        let myPlayerId = null;
        let myPlayerColor = '#FF0000'; // Colore di default

        const playerIdDisplay = document.getElementById('playerIdDisplay');
        const playerColorDisplay = document.getElementById('playerColorDisplay');
        const playerColorPicker = document.getElementById('playerColorPicker');
        const changeColorButton = document.getElementById('changeColorButton');
        const messageBox = document.getElementById('messageBox');

        // --- Funzioni UtilitÃ  ---
        function showMessage(text, duration = 3000, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? '#F56565' : '#48BB78'; // Rosso per errore, Verde per successo
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // --- Inizializzazione Socket.IO ---
        // MODIFICATA: Connessione diretta a localhost:3000
        const socket = io('http://localhost:3000', {
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
        });


        // --- Gestione Eventi Socket.IO ---
        socket.on('connect', () => {
            console.log('Connesso al server con ID:', socket.id);
            myPlayerId = socket.id;
            playerIdDisplay.textContent = myPlayerId;
            socket.emit('playerReady', { color: myPlayerColor }); // Invia il colore iniziale
            showMessage('Connesso al server!');
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnesso dal server:', reason);
            playerIdDisplay.textContent = 'Disconnesso';
            showMessage('Disconnesso dal server.', 3000, true);
        });
        
        socket.on('connect_error', (err) => {
          console.error('Errore di connessione:', err.message);
          playerIdDisplay.textContent = 'Errore connessione';
          showMessage(`Errore di connessione: ${err.message}. Assicurati che il server sia in esecuzione.`, 5000, true);
        });

        socket.on('assignPlayerDetails', (details) => {
            myPlayerId = details.id;
            myPlayerColor = details.color;
            playerIdDisplay.textContent = myPlayerId;
            playerColorDisplay.style.backgroundColor = myPlayerColor;
            playerColorPicker.value = myPlayerColor;
            console.log('Dettagli giocatore assegnati:', details);
        });

        socket.on('updateGrid', (newGrid) => {
            gameGrid = newGrid;
            drawGrid();
        });

        socket.on('playerColorUpdated', (data) => {
            if (data.playerId === myPlayerId) {
                myPlayerColor = data.newColor;
                playerColorDisplay.style.backgroundColor = myPlayerColor;
                playerColorPicker.value = myPlayerColor; // Aggiorna anche il picker
                showMessage('Colore aggiornato!');
            }
        });
        
        socket.on('errorOccurred', (errorMessage) => {
            console.error('Errore dal server:', errorMessage);
            showMessage(`Errore: ${errorMessage}`, 4000, true);
        });


        // --- Funzioni di Disegno ---
        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); 

            if (!gameGrid || gameGrid.length === 0) {
                for (let y = 0; y < GRID_HEIGHT; y++) {
                    for (let x = 0; x < GRID_WIDTH; x++) {
                        ctx.strokeStyle = '#4A5568'; 
                        ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
                return;
            }

            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const cell = gameGrid[y] && gameGrid[y][x] ? gameGrid[y][x] : { owner: null, color: '#2D3748' };
                    
                    ctx.fillStyle = cell.color || '#2D3748'; 
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    
                    ctx.strokeStyle = '#4A5568'; 
                    ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
        }

        // --- Gestione Input ---
        canvas.addEventListener('click', (event) => {
            if (!myPlayerId) {
                showMessage('Non ancora connesso al server per interagire.', 3000, true);
                return;
            }
            const rect = canvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;

            const tileX = Math.floor(mouseX / TILE_SIZE);
            const tileY = Math.floor(mouseY / TILE_SIZE);

            if (tileX >= 0 && tileX < GRID_WIDTH && tileY >= 0 && tileY < GRID_HEIGHT) {
                console.log(`Cella cliccata: (${tileX}, ${tileY})`);
                socket.emit('claimTile', { x: tileX, y: tileY, color: myPlayerColor });
            }
        });

        changeColorButton.addEventListener('click', () => {
            if (!myPlayerId) {
                 showMessage('Connettiti prima di cambiare colore.', 3000, true);
                return;
            }
            const newColor = playerColorPicker.value;
            socket.emit('changePlayerColor', { newColor: newColor });
        });
        
        playerColorPicker.addEventListener('input', (event) => {
            playerColorDisplay.style.backgroundColor = event.target.value;
        });

        drawGrid(); 
        showMessage("In attesa della connessione al server...", 2000);

    </script>
</body>
</html>